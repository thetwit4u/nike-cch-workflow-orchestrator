schema_version: "1.1.2"
workflow_name: "Simplified Import US Workflow"
workflow_id: "import_us_v1_simplified"
entry_point: Check_Filing_Pack_Creation_Started

initial_context:
  - deliverySetId
  - deliverySetURI

nodes:
  Check_Filing_Pack_Creation_Started:
    type: condition
    title: "Check if Filing Pack Creation is Already Scheduled"
    condition_on_key: "data.filingpackCreationStarted"
    branches:
      "true": Log_Error_Already_Started
      "_default": Retrieve_Planned_Discharge_Date # Treat null/missing/false as the default path

  Retrieve_Planned_Discharge_Date:
    type: library_call
    title: "Retrieve Planned Discharge Date for OTF"
    library_function_id: "s3#read_jsonpath"
    parameters:
      input_s3_uri_key: "data.deliverySetURI"
      jsonpath_expression: "$.consignment.plannedDischargeDate"
    output_key: "data.plannedDischargeDate"
    on_success: Calculate_OTF_Date
    on_failure: Handle_Error

  Calculate_OTF_Date:
    type: library_call
    title: "Calculate Optimal Time of Filing (OTF)"
    library_function_id: "core#calculate_timedelta"
    parameters:
      date_context_key: "data.plannedDischargeDate"
      timedelta:
        days: -10
    output_key: "data.otfDate"
    on_success: End_Workflow # Simplified path
    on_failure: Handle_Error

  Log_Error_Already_Started:
    type: log_error
    title: "Log Error: Already Started"
    default_error_code: "OTF-001"
    default_message: "Filing pack creation process was already started for this workflow."
    on_success: End_Workflow

  Handle_Error:
    type: log_error
    title: "Generic Error Handler"
    default_error_code: "GEN-001"
    message_from_context_key: "_internalError"
    default_message: "A general error occurred in the workflow."
    on_success: End_Workflow

  End_Workflow:
    type: end
    title: "End Workflow" 