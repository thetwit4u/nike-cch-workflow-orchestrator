{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "CHHSystemEvent",
  "description": "A standardized event published by any CCH component to report a significant state change or business moment.",
  "type": "object",
  "$defs": {
    "CCHMessage": {
      "title": "CCH Message",
      "description": "A standardized message object for reporting errors, warnings, or info.",
      "type": "object",
      "properties": {
        "messageId": { "type": "string", "format": "uuid" },
        "timestamp": { "type": "string", "format": "date-time" },
        "level": { "enum": ["ERROR", "WARNING", "INFO"] },
        "code": { "type": "string" },
        "summary": { "type": "string" },
        "context": { "type": "object", "additionalProperties": true }
      },
      "required": ["messageId", "timestamp", "level", "code", "summary"]
    },
    "ControllerContext": {
      "type": "object",
      "description": "Context specific to events published by the Trade Flow Controller.",
      "properties": {
        "plannedDischargeDate": { "type": "string", "format": "date-time" },
        "voyageNbr": { "type": "string" },
        "modeOfTransport": { "type": "string" },
        "consignmentId": { "type": "string" },
        "consignmentURI": { "type": "string", "format": "uri" },
        "originCountry": { "type": "string" },
        "dischargeCountry": { "type": "string" },
        "customsTerritory": { "type": "string" },
        "expectedNbrOfShipments": { "type": "integer" },
        "actualNbrOfShipments": { "type": "integer" }
      },
      "required": ["plannedDischargeDate", "voyageNbr", "modeOfTransport", "consignmentId", "consignmentURI", "originCountry", "dischargeCountry", "customsTerritory", "expectedNbrOfShipments", "actualNbrOfShipments"]
    },
    "WorkflowStep": {
      "type": "object",
      "description": "Represents a single step within a workflow definition.",
      "properties": {
        "name": { "type": "string", "description": "The unique machine-readable name (ID) of the node." },
        "title": { "type": "string", "description": "The human-readable title of the node." },
        "type": { "type": "string", "description": "The type of the node (e.g., 'async_request', 'condition')." }
      },
      "required": ["name", "title", "type"]
    }
  },
  "properties": {
    "eventId": {
      "type": "string",
      "format": "uuid",
      "description": "A unique identifier for this specific event."
    },
    "eventType": {
      "type": "string",
      "description": "A code describing the type of event, e.g., 'WorkflowStateChange', 'TradeFlowStarted'.",
      "example": "WorkflowStateChange"
    },
    "eventTimestamp": {
      "type": "string",
      "format": "date-time",
      "description": "The ISO 8601 timestamp of when the event was generated."
    },
    "source": {
      "type": "string",
      "description": "The name of the CCH component that published the event.",
      "enum": ["WorkflowOrchestrator", "TradeFlowController"]
    },
    "correlationId": {
      "type": "string",
      "description": "The end-to-end business tracking ID, typically reflecting the consignmentId or other primary business key."
    },
    "businessContext": {
      "type": "object",
      "description": "The data context relevant to this event. For the Orchestrator, this is the entire workflow state.",
      "additionalProperties": true
    },
    "workflowContext": {
      "type": "object",
      "description": "OPTIONAL: Contains workflow-specific identifiers. MUST be included if source is 'WorkflowOrchestrator'.",
      "properties": {
        "workflowInstanceId": { "type": "string", "format": "uuid" },
        "workflowName": { "type": "string" },
        "workflowDefinitionURI": { "type": "string", "format": "uri" }
      },
      "required": ["workflowInstanceId", "workflowDefinitionURI"]
    },
    "controllerContext": {
        "$ref": "#/$defs/ControllerContext"
    },
    "transition": {
      "type": "object",
      "description": "OPTIONAL: Describes a workflow step transition. MUST be included if source is 'WorkflowOrchestrator'.",
      "properties": {
        "currentStep": {
          "description": "The node that has just completed execution to produce this event. Null for the initial start of the workflow.",
          "$ref": "#/$defs/WorkflowStep"
        },
        "nextSteps": {
          "type": "array",
          "description": "An array of the next node(s) the workflow is about to execute. An array with multiple items indicates a fork. An empty array indicates the workflow has reached an end state.",
          "items": { "$ref": "#/$defs/WorkflowStep" }
        }
      },
      "required": ["currentStep", "nextSteps"]
    },
    "messages": {
      "type": "array",
      "description": "OPTIONAL: A list of messages (errors, warnings, info) associated with this event.",
      "items": { "$ref": "#/$defs/CCHMessage" }
    }
  },
  "required": ["eventId", "eventType", "eventTimestamp", "source", "correlationId", "businessContext"],
  "allOf": [
    {
      "if": { "properties": { "source": { "const": "WorkflowOrchestrator" } } },
      "then": { "required": ["workflowContext", "transition"] }
    },
    {
      "if": { "properties": { "source": { "const": "TradeFlowController" } } },
      "then": { "required": ["controllerContext"] }
    }
  ]
}